# -*- coding: utf-8 -*-
"""
Created on Sun Jul 30 23:06:55 2017

@author: chen
"""

import os
import numpy as np
import pandas as pd

def Read_jsyb(pathtiqu, name):
    try:
        filename = os.path.join(pathtiqu, name)
        jsyb = pd.read_excel(filename, '客户交易结算月报', header=None)
        df1 = pd.DataFrame()
        a1 = pd.Series(jsyb.iloc[4,7], index=jsyb.index[:1])
        df1['交易月份'] = a1
        a2 = pd.Series(jsyb.iloc[9,2], index=jsyb.index[:1])
        df1['上月结存'] = a2
        a3 = pd.Series(jsyb.iloc[10,2], index=jsyb.index[:1])
        df1['当月存取合计'] = a3
        a4 = pd.Series(jsyb.iloc[11,2], index=jsyb.index[:1])
        df1['当月盈亏'] = a4
        a5 = pd.Series(jsyb.iloc[12,2], index=jsyb.index[:1])
        df1['当月总权利金'] = a5
        a6 = pd.Series(jsyb.iloc[13,2], index=jsyb.index[:1])
        df1['当月手续费'] = a6
        a7 = pd.Series(jsyb.iloc[14,2], index=jsyb.index[:1])
        df1['当月结存'] = a7
        a8 = pd.Series(jsyb.iloc[15,2], index=jsyb.index[:1])
        df1['浮动盈亏'] = a8
        b1 = pd.Series(jsyb.iloc[9,7], index=jsyb.index[:1])
        df1['客户权益'] = b1
        b2 = pd.Series(jsyb.iloc[10,7], index=jsyb.index[:1])
        df1['实有货币资金'] = b2
        b3 = pd.Series(jsyb.iloc[11,7], index=jsyb.index[:1])
        df1['非货币充抵金额'] = b3
        b4 = pd.Series(jsyb.iloc[12,7], index=jsyb.index[:1])
        df1['货币充抵金额'] = b4
        b5 = pd.Series(jsyb.iloc[13,7], index=jsyb.index[:1])
        if type(jsyb.iloc[13,7]) != type(1):
            b5 = np.repeat(np.nan, len(b5))
        df1['冻结资金'] = b5
        b6 = pd.Series(jsyb.iloc[14,7], index=jsyb.index[:1])
        df1['保证金占用'] = b6
        b7 = pd.Series(jsyb.iloc[15,7], index=jsyb.index[:1])
        df1['可用资金'] = b7
        b8 = pd.Series(jsyb.iloc[16,7], index=jsyb.index[:1])
        df1['风险度'] = b8
        b9 = pd.Series(jsyb.iloc[17,7], index=jsyb.index[:1])
        df1['追加保证金'] = b9
        crjmx = jsyb.iloc[21:-3,:]
        if len(crjmx.index) != 0:
            crjmx.columns = ['交易日期', 1, '入金', 3, '出金', 5, '方式', 7, '摘要']
            crjmx = crjmx[['交易日期', '入金', '出金', '方式', '摘要']]
            crjmxb = crjmx.copy()
            a = pd.Series(jsyb.iloc[4,7], index=crjmxb.index)
            crjmxb['交易月份'] = a
            crjmxb.index = range(len(crjmxb.index))
            df = pd.merge(df1, crjmxb, how='outer', on='交易月份', left_index=True, right_index=True)
        else:
            df = df1
    except Exception as e:
        print("==>" + filename + "'客户交易结算月报' ***读取*** 异常，请检查！")
        print("Error:", e)
    else:
        print("%s is successfully read!" %name)
        return(df)

def Append_jsyb(pathtiqu):
    try:
        files = os.listdir(pathtiqu)
        n = 0
        for name in files:
            if name[-3:] != 'xls':
                continue
            n = n + 1
            if n == 1:
                df = Read_jsyb(pathtiqu, name)
                continue
            df2 = Read_jsyb(pathtiqu, name)
            #df = pd.concat([df, df2])
            df = df.append(df2, ignore_index=True).drop_duplicates()
    except Exception as e:
        print("==>'客户交易结算月报' ***合并*** 异常，请检查！")
        print("Error:", e)
    else:
        print("%s is successfully concat!" %name)
        return(df)

def Update_jsyb(file_jsyb, pathtiqu):
    try:
        df1 = pd.read_csv(file_jsyb, encoding='gbk')
        df2 = Append_jsyb(pathtiqu)
        #df = pd.concat([df1, df2]).drop_duplicates()
        df = df1.append(df2, ignore_index=True).drop_duplicates()
        df = df[['交易日期','交易月份','上月结存','当月存取合计','当月盈亏','当月总权利金','当月手续费','当月结存','浮动盈亏',
                 '客户权益','实有货币资金','非货币充抵金额','货币充抵金额','冻结资金','保证金占用','可用资金','风险度','追加保证金',
                 '入金','出金','方式','摘要']]
    except Exception as e:
        print("==>" + file_jsyb + "'客户交易结算月报' ***更新*** 异常，请检查！")
        print("Error:", e)
    else:
        print("%s is successfully Update!" %file_jsyb)
        return(df)

def Read_jsyb_pzhz(pathtiqu, name):
    try:
        filename = os.path.join(pathtiqu, name)
        pzhz = pd.read_excel(filename,'品种汇总',header=None)
        pzhzb = pzhz.iloc[10:-1,0:6]
        pzhzb.columns = ['交易日期','品种','手数','成交额','手续费','平仓盈亏']
        pzhzb.index = range(len(pzhzb.index))
        pzhzb = pzhzb.copy()
        a = pd.Series(pzhz.iloc[2,7],index=pzhzb.index)
        pzhzb['交易月份'] = a
    except Exception as e:
        print("==>" + filename + "'客户交易结算月报-->品种汇总' ***读取*** 异常，请检查！")
        print("error:", e)
    else:
        print("%s is successfully read!" %name)
        return(pzhzb)

def Append_jsyb_pzhz(pathtiqu):
    try:
        files = os.listdir(pathtiqu)
        n = 0
        for name in files:
            if name[-3:] != 'xls':
                continue
            n = n + 1
            if n == 1:
                df = Read_jsyb_pzhz(pathtiqu, name)
                continue
            df2 = Read_jsyb_pzhz(pathtiqu, name)
            #df = pd.concat([df, df2])
            df = df.append(df2, ignore_index=True).drop_duplicates()
    except Exception as e:
        print("==>" + name + "'客户交易结算月报-->品种汇总' ***合并*** 异常，请检查！")
        print("Error:", e)
    else:
        print("%s is successfully concat!" %name)
        return(df)

def Update_jsyb_pzhz(file_pzhz, pathtiqu):
    try:
        df1 = pd.read_csv(file_pzhz, encoding='gbk')
        df2 = Append_jsyb_pzhz(pathtiqu)
        #df = pd.concat([df1, df2]).drop_duplicates()
        df = df1.append(df2, ignore_index=True).drop_duplicates()
    except Exception as e:
        print("==>" + file_pzhz + "'客户交易结算月报-->品种汇总' ***更新*** 异常，请检查！")
        print("Error:", e)
    else:
        print("%s is successfully Update!" %file_pzhz)
        return(df)

def Read_jsyb_ccmx(pathtiqu, name):
    try:
        filename = os.path.join(pathtiqu, name)
        ccmx = pd.read_excel(filename,'持仓明细',header=None)
        ccmxb = ccmx.iloc[10:-1,:]
        ccmxb.columns = ['合约','成交序号','买持仓','买入价','卖持仓','卖出价','昨结算价','今结算价','持仓盈亏',"投机/套保","交易编码","交易日期"]
        ccmxb.index = range(len(ccmxb.index))
        ccmxb = ccmxb.copy()
        a = pd.Series(ccmx.iloc[2,7],index=ccmxb.index)
        ccmxb['交易月份'] = a
    except Exception as e:
        print("==>" + filename + "'客户交易结算月报-->持仓明细' ***读取*** 异常，请检查！")
        print("error:", e)
    else:
        print("%s is successfully read!" %name)
        return(ccmxb)

def Append_jsyb_ccmx(pathtiqu):
    try:
        files = os.listdir(pathtiqu)
        n = 0
        for name in files:
            if name[-3:] != 'xls':
                continue
            n = n + 1
            if n == 1:
                df = Read_jsyb_ccmx(pathtiqu, name)
                continue
            df2 = Read_jsyb_ccmx(pathtiqu, name)
            #df = pd.concat([df, df2])
            df = df.append(df2, ignore_index=True).drop_duplicates()
    except Exception as e:
        print("==>" + name + "'客户交易结算月报-->持仓明细' ***合并*** 异常，请检查！")
        print("Error:", e)
    else:
        print("%s is successfully concat!" %name)
        return(df)

def Update_jsyb_ccmx(file_ccmx, pathtiqu):
    try:
        df1 = pd.read_csv(file_ccmx, encoding='gbk')
        df2 = Append_jsyb_ccmx(pathtiqu)
        #df = pd.concat([df1, df2]).drop_duplicates()
        df = df1.append(df2, ignore_index=True).drop_duplicates()
    except Exception as e:
        print("==>" + file_ccmx + "'客户交易结算月报-->持仓明细' ***更新*** 异常，请检查！")
        print("Error:", e)
    else:
        print("%s is successfully Update!" %file_ccmx)
        return(df)

def Read_jsyb_cjmx(pathtiqu, name):
    try:
        filename = os.path.join(pathtiqu, name)
        cjmx = pd.read_excel(filename,'成交明细',header=None)
        cjmxb = cjmx.iloc[10:-1,:]
        cjmxb.columns = ["交易日期","合约","成交序号","成交时间","买/卖","投机/套保","成交价","手数","成交额","开/平","手续费","平仓盈亏","实际成交日期"]
        cjmxb.index = range(len(cjmxb.index))
        cjmxb = cjmxb.copy()
        a = pd.Series(cjmx.iloc[2,7],index=cjmxb.index)
        cjmxb['交易月份'] = a
    except Exception as e:
        print("==>" + filename + "'客户交易结算月报-->成交明细' ***读取*** 异常，请检查！")
        print("error:", e)
    else:
        print("%s is successfully read!" %name)
        return(cjmxb)

def Append_jsyb_cjmx(pathtiqu):
    try:
        files = os.listdir(pathtiqu)
        n = 0
        for name in files:
            if name[-3:] != 'xls':
                continue
            n = n + 1
            if n == 1:
                df = Read_jsyb_cjmx(pathtiqu, name)
                continue
            df2 = Read_jsyb_cjmx(pathtiqu, name)
            #df = pd.concat([df, df2])
            df = df.append(df2, ignore_index=True).drop_duplicates()
    except Exception as e:
        print("==>" + name + "'客户交易结算月报-->成交明细' ***合并*** 异常，请检查！")
        print("Error:", e)
    else:
        print("%s is successfully concat!" %name)
        return(df)

def Update_jsyb_cjmx(file_cjmx, pathtiqu):
    try:
        df1 = pd.read_csv(file_cjmx, encoding='gbk')
        df2 = Append_jsyb_cjmx(pathtiqu)
        #df = pd.concat([df1, df2]).drop_duplicates()
        df = df1.append(df2, ignore_index=True).drop_duplicates()
    except Exception as e:
        print("==>" + file_cjmx + "'客户交易结算月报-->成交明细' ***更新*** 异常，请检查！")
        print("Error:", e)
    else:
        print("%s is successfully Update!" %file_cjmx)
        return(df)

if __name__ == '__main__':
    pathtiqu = 'F:\\Text02\\ZhuRiDingShi\\'
    #file_jsyb = pathtiqu + 'jsyb.csv'
    #df_jsyb = Update_jsyb(file_jsyb, pathtiqu)
    #print(df_jsyb)
    #df.to_csv(pathtiqu + 'jsyb.csv', mode='w', header=True, index=False)
    #file_pzhz = pathtiqu + 'pzhz.csv'
    #df_pzhz = Update_jsyb_pzhz(file_pzhz, pathtiqu)
    #print(df_pzhz)
    #file_ccmx = pathtiqu + 'ccmx.csv'
    #df_ccmx = Update_jsyb_ccmx(file_ccmx, pathtiqu)
    #print(df_ccmx)
    file_cjmx = pathtiqu + 'cjmx.csv'
    df_cjmx = Update_jsyb_cjmx(file_cjmx, pathtiqu)
    print(df_cjmx)



